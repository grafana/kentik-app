{"version":3,"sources":["../../src/datasource/datasource.js"],"names":[],"mappings":"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","file":"datasource.js","sourcesContent":["import {metricList, unitList} from './metric_def';\nimport _ from 'lodash';\nimport TableModel from 'app/core/table_model';\n\nclass KentikDatasource {\n\n  constructor(instanceSettings, backendSrv, templateSrv)  {\n    this.instanceSettings = instanceSettings;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n  }\n\n  interpolateDeviceField(value, variable) {\n    // if no multi or include all do not regexEscape\n    if (!variable.multi && !variable.includeAll) {\n      return value;\n    }\n\n    if (typeof value === 'string') {\n      return value;\n    }\n\n    return value.join(',');\n  }\n\n  query(options) {\n    if (!options.targets || options.targets.length === 0) {\n      return Promise.resolve({data: []});\n    }\n\n    var target = options.targets[0];\n    var deviceNames = this.templateSrv.replace(target.device, options.scopedVars, this.interpolateDeviceField.bind(this));\n\n    var query = {\n      version: \"2.01\",\n      query: {\n        device_name: deviceNames,\n        time_type: 'fixed', // or fixed\n        lookback_seconds: 3600,\n        starting_time: options.range.from.utc().format(\"YYYY-MM-DD HH:mm:ss\"),\n        ending_time: options.range.to.utc().format(\"YYYY-MM-DD HH:mm:ss\"),\n        metric: this.templateSrv.replace(target.metric),\n        fast_data: \"Auto\", // or Fast or Full\n        units: this.templateSrv.replace(target.unit)\n      },\n      filterSettings: {\n        connector: 'All',\n        filterString: '',\n        filterGroups: []\n      }\n    };\n\n    var endpoint = 'timeSeriesData';\n    if (target.mode === 'table') {\n      endpoint = 'topXData';\n    }\n\n    return this.backendSrv.datasourceRequest({\n      method: 'POST',\n      url: 'api/plugin-proxy/kentik-app/api/v4/dataExplorer/' + endpoint,\n      data: query\n    }).then(this.processResponse.bind(this, query, endpoint));\n  }\n\n  processResponse(query, endpoint, data) {\n    if (!data.data) {\n      return Promise.reject({message: 'no kentik data'});\n    }\n\n    var rows = data.data;\n    if (rows.length === 0) {\n      return [];\n    }\n\n    var metricDef = _.findWhere(metricList, {value: query.query.metric});\n    var unitDef = _.findWhere(unitList, {value: query.query.units});\n\n    if (endpoint === 'topXData') {\n      return this.processTopXData(rows, metricDef, unitDef);\n    } else {\n      return this.processTimeSeries(rows, metricDef, unitDef);\n    }\n  }\n\n  processTimeSeries(rows, metricDef, unitDef) {\n    var seriesList = {};\n\n    for (var i = 0; i < rows.length; i++) {\n      var row = rows[i];\n      var value = row[unitDef.field];\n      var seriesName = row[metricDef.field];\n      var series = seriesList[seriesName];\n\n      if (!series) {\n        series = seriesList[seriesName] = {\n          target: seriesName,\n          datapoints: [],\n          unit: unitDef.gfUnit,\n          axisLabel: unitDef.gfAxisLabel\n        };\n      }\n\n      if (unitDef.transform) {\n        value = unitDef.transform(value, row);\n      }\n\n      var time = new Date(row.i_start_time).getTime();\n      series.datapoints.push([value, time]);\n    }\n\n    // turn seriesList hash to array\n    return { data: _.map(seriesList, value => value) };\n  }\n\n  processTopXData(rows, metricDef, unitDef) {\n    var table = new TableModel();\n    table.columns.push({text: metricDef.text});\n    table.columns.push({text: '95th Percentile'});\n    table.columns.push({text: 'Max'});\n    table.columns.push({text: 'Avg'});\n\n    for (var i = 0; i < rows.length; i++) {\n      var row = rows[i];\n      var value = row[unitDef.field];\n      var seriesName = row[metricDef.field];\n      var p95th = parseFloat(row[\"p95th_both\"]);\n      var max = parseFloat(row[\"max_both\"]);\n\n      if (unitDef.transform) {\n        value = unitDef.transform(value, row);\n      }\n\n      table.rows.push([seriesName, p95th, max, value]);\n    }\n\n    return {data: [table]};\n  }\n\n  metricFindQuery(query) {\n    if (query === 'metrics()') {\n      return Promise.resolve(metricList);\n    }\n    if (query === 'units()') {\n      return Promise.resolve(unitList);\n    }\n\n    return this.backendSrv.datasourceRequest({\n      method: 'GET',\n      url: 'api/plugin-proxy/kentik-app/api/v1/device/list',\n    }).then(res => {\n      if (!res.data || !res.data.device) {\n        return [];\n      }\n\n      return res.data.device.map(device => {\n        return {text: device.device_name, value: device.device_name};\n      });\n    });\n  }\n}\n\nexport {KentikDatasource};\n"]}